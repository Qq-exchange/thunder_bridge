version: "2"

services:
  contracts:
    image: "thunder_bridge_deployer"
    build: ../contracts
    command: bash
    volumes:
      - /contracts
      - ../contracts/contracts:/contracts/contracts
      - ../contracts/migrations:/contracts/migrations

  truffle:
    image: "trufflesuite/ganache-cli:latest"
    ports:
     - "7545:8545"
    command: "-m 'wisdom zero output drift choice bright east stuff craft inform invest patient' --callGasLimit 10000000000000 -l 10000000000000 -g 10000000000000000 -e 10000000000000 -i 5777"

  pala:
    image: "pala-for-truffle-test"
    build: e2e/thunder
    restart: always
    ports:
     - "7545:8545"

  truffle-test:
    network_mode: host
    build: .
    stdin_open: true
    tty: true
    volumes:
      - ./truffle-test:/app/truffle-test
      - ./data:/app/data
    command: npm run truffle-test

  truffle-erc-to-erc:
    extends: truffle-test
    volumes_from:
      - contracts:rw
    env_file:
      - ./envs/erc-to-erc.env
    depends_on:
      - truffle
      - contracts

  truffle-native-to-erc:
    extends: truffle-test
    volumes_from:
      - contracts:rw
    env_file:
      - ./envs/native-to-erc.env
    depends_on:
      - truffle
      - contracts

  truffle-test-pala:
    extends: truffle-test
    volumes_from:
      - contracts:rw
    env_file:
      - ./envs/erc_to_erc.env
    command: npm run truffle-test:pala
    depends_on:
      - pala
      - contracts

  redis:
    image: "redis:4"
    ports:
     - "6379:6379"
  rabbitmq:
    image: rabbitmq:management-alpine
    ports:
      - 15672:15672
      - 5672:5672
